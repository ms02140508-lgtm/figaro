<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ğŸ¾ãƒ•ã‚£ã‚¬ãƒ­ã®å››ç›®ä¸¦ã¹ğŸ¾</title>

<!-- â­ PWA è¿½åŠ  -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">

<!-- â­ iPhoneå‘ã‘ PWA è¡¨ç¤ºç”¨ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --bg:#111;
  --board:#222;
  --cell:#333;
  --text:#fff;
  --xcolor:#4fa7ff;
  --ocolor:#ff5a5a;
}
.light{
  --bg:#fafafa;
  --board:#ffffff;
  --cell:#e6e6e6;
  --text:#111;
}
.turn-o{ background:#2a0000; }
.turn-x{ background:#001a33; }

body{
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  margin:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  padding-bottom:80px;
  transition:background .25s;
}

.board-wrap{
  width:min(96vw,480px);
  height:min(96vw,480px);
  display:flex;
  align-items:center;
  justify-content:center;
}

#board{
  background:var(--board);
  padding:8px;
  border-radius:10px;
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
  width:100%;
  height:100%;
}

.cell{
  background:var(--cell);
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  aspect-ratio:1/1;
  font-size:32px;
  line-height:1;
  user-select:none;
  position:relative;
}

.block{ background:#555; }
.mark-o{ color:var(--ocolor); }
.mark-x{ color:var(--xcolor); }

.protect-overlay{
  position:absolute;
  inset:2px;
  border-radius:10px;
  background:radial-gradient(circle, rgba(255,255,255,.35), rgba(255,255,255,0));
  border:2px solid rgba(255,255,255,.4);
  pointer-events:none;
}

.win{
  animation:shine .7s infinite alternate;
  box-shadow:0 0 12px 3px gold inset;
}
@keyframes shine{
  from{ filter:brightness(1); }
  to{ filter:brightness(2); }
}

.explode{
  animation:
    explodeFlash .45s ease-out both,
    explodeShake .45s ease-out both;
}
@keyframes explodeFlash{
  0%{background:#f00;transform:scale(1);}
  40%{background:#f55;transform:scale(1.2);}
  100%{background:var(--cell);}
}
@keyframes explodeShake{
  0%{transform:translate(0,0);}
  25%{transform:translate(-2px,2px);}
  50%{transform:translate(2px,-2px);}
  75%{transform:translate(-2px,-2px);}
  100%{transform:translate(0,0);}
}

.ruined{
  background:repeating-linear-gradient(135deg,#1a1a1a 0 6px,#0d0d0d 6px 12px);
  filter:brightness(.6);
  pointer-events:none;
}

.shake{
  animation:shakeX .35s;
}
@keyframes shakeX{
  0%,100%{transform:translateX(0);}
  25%{transform:translateX(-6px);}
  50%{transform:translateX(6px);}
  75%{transform:translateX(-6px);}
}

.themeBtn{
  font-size:26px;
  background:none;
  border:none;
  cursor:pointer;
}

.skill-panel{
  width:min(96vw,480px);
  display:flex;
  gap:6px;
}

.skill-btn{
  flex:1;
  padding:10px 6px 6px 6px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  color:#fff;
  font-size:13px;
  position:relative;
  box-shadow:0 4px 10px rgba(0,0,0,.35);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
}
.skill-o{ background:#b83232; }
.skill-x{ background:#245d9c; }

.badge{
  position:absolute;
  top:4px;
  right:6px;
  background:#0008;
  padding:2px 7px;
  border-radius:999px;
  font-size:11px;
}

.skill-btn.active{
  outline:3px solid gold;
  box-shadow:0 0 14px 2px gold;
}
.skill-btn:disabled{
  filter:grayscale(.9);
  opacity:.6;
}

.top-controls{ transform:rotate(180deg); }

.info{ font-size:14px; }

.control-row{
  width:min(96vw,480px);
  display:flex;
  gap:8px;
}
.reset-btn{
  flex:1;
  padding:10px;
  border-radius:12px;
  border:none;
  background:#666;
  color:#fff;
}
</style>
</head>

<body>

<h3>ğŸ±ãƒ•ã‚£ã‚¬ãƒ­ã®ã€‡âœ•ã‚²ãƒ¼ãƒ ğŸ±</h3>

<button id="modeBtn" class="themeBtn">ğŸŒ™</button>

<div class="skill-panel top-controls">
  <button id="x-block" class="skill-btn skill-x">ğŸ”’ å°é– <span class="badge" id="x-block-b"></span></button>
  <button id="x-override" class="skill-btn skill-x">â™» ä¸Šæ›¸ <span class="badge" id="x-override-b"></span></button>
  <button id="x-protect" class="skill-btn skill-x">ğŸ›¡ ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆ <span class="badge" id="x-protect-b"></span></button>
</div>

<div id="turnInfo" class="info"></div>

<div class="board-wrap">
  <div id="board"></div>
</div>

<div class="skill-panel">
  <button id="o-block" class="skill-btn skill-o">ğŸ”’ å°é– <span class="badge" id="o-block-b"></span></button>
  <button id="o-override" class="skill-btn skill-o">â™» ä¸Šæ›¸ <span class="badge" id="o-override-b"></span></button>
  <button id="o-protect" class="skill-btn skill-o">ğŸ›¡ ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆ <span class="badge" id="o-protect-b"></span></button>
</div>

<div class="control-row">
  <button id="reset" class="reset-btn">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
// --- å¤‰æ•°ãƒ»åˆæœŸçŠ¶æ…‹ ---
const N=7;
let board=[];
let current="O";
let gameOver=false;
let phase="mine";
let usedSkillThisTurn=false;
let mines={O:null,X:null};
let skill={
  O:{block:1,override:1,protect:1,mode:null},
  X:{block:1,override:1,protect:1,mode:null}
};

// --- åˆæœŸåŒ– ---
function init(){
  const b=document.getElementById("board");
  b.innerHTML="";
  board=[];
  current="O";
  gameOver=false;
  phase="mine";
  usedSkillThisTurn=false;
  mines={O:null,X:null};

  for(let r=0;r<N;r++){
    board[r]=[];
    for(let c=0;c<N;c++){
      board[r][c]={val:"",protect:false,ruined:false};
      const el=document.createElement("div");
      el.className="cell";
      el.onclick=()=>cellClick(r,c);
      b.appendChild(el);
    }
  }

  let k=0;
  while(k<10){
    const r=Math.floor(Math.random()*N);
    const c=Math.floor(Math.random()*N);
    if(board[r][c].val===""){
      board[r][c].val="#";
      k++;
    }
  }

  updateTurn();
  updateSkillButtons();
  render();
}

// --- ã‚»ãƒ«æç”»ãƒ»æ›´æ–°é–¢æ•° ---
function cellEl(r,c){ return document.getElementById("board").children[r*N+c]; }
function render(){
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      const el=cellEl(r,c);
      const d=board[r][c];
      el.className="cell"; el.textContent="";
      if(d.ruined){ el.classList.add("ruined"); continue; }
      if(d.val==="#") el.classList.add("block");
      if(d.val==="O"){ el.textContent="ã€‡"; el.classList.add("mark-o"); }
      if(d.val==="X"){ el.textContent="âœ•"; el.classList.add("mark-x"); }
      if(d.protect){
        const o=document.createElement("div");
        o.className="protect-overlay";
        el.appendChild(o);
      }
    }
  }
}

function updateTurn(){
  const info=document.getElementById("turnInfo");
  document.body.classList.remove("turn-o","turn-x");
  document.body.classList.add(current==="O"?"turn-o":"turn-x");
  if(phase==="mine"){
    info.textContent=`åœ°é›·é…ç½®ï¼š${current==="O"?"ã€‡":"âœ•"}`;
  }else if(!gameOver){
    info.textContent=`æ‰‹ç•ªï¼š${current==="O"?"ã€‡":"âœ•"}`;
  }
}

// --- å‹åˆ©åˆ¤å®š ---
function checkWin(r,c){
  const dirs=[[1,0],[0,1],[1,1],[1,-1]];
  for(const [dR,dC] of dirs){
    let cells=[[r,c]];
    let rr=r+dR, cc=c+dC;
    while(true){
      rr=(rr+N)%N; cc=(cc+N)%N;
      if(board[rr][cc].val===current) cells.push([rr,cc]); else break;
      rr+=dR; cc+=dC;
    }
    rr=r-dR; cc=c-dC;
    while(true){
      rr=(rr+N)%N; cc=(cc+N)%N;
      if(board[rr][cc].val===current) cells.push([rr,cc]); else break;
      rr-=dR; cc-=dC;
    }
    if(cells.length>=4){
      cells.forEach(([r,c])=>cellEl(r,c).classList.add("win"));
      document.getElementById("turnInfo").textContent=`${current==="O"?"ã€‡":"âœ•"} ã®å‹åˆ©ï¼`;
      gameOver=true;
      return true;
    }
  }
  return false;
}

// --- åœ°é›·å‡¦ç† ---
function isMine(r,c){ return (mines.O && mines.O.r===r && mines.O.c===c) || (mines.X && mines.X.r===r && mines.X.c===c); }
function clearMine(r,c){ if(mines.O && mines.O.r===r && mines.O.c===c) mines.O=null; if(mines.X && mines.X.r===r && mines.X.c===c) mines.X=null; }
function explode(r,c){ const el=cellEl(r,c); el.classList.add("explode"); setTimeout(()=>{ el.classList.remove("explode"); board[r][c].ruined=true; render(); },450); }
function triggerMine(r,c){ if(!isMine(r,c)) return false; clearMine(r,c); explode(r,c); nextTurn(); return true; }

// --- ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ ---
function cellClick(r,c){
  if(gameOver) return;
  const d=board[r][c];
  if(d.ruined) return;

  if(phase==="mine"){
    if(!mines[current]){
      mines[current]={r,c};
      if(mines.O && mines.X){ phase="play"; current="O"; usedSkillThisTurn=false; updateTurn();}
      else nextTurn();
    }
    return;
  }

  if(triggerMine(r,c)) return;

  const mode=skill[current].mode;
  if(usedSkillThisTurn && mode){ const el=cellEl(r,c); el.classList.add("shake"); setTimeout(()=>el.classList.remove("shake"),350); return; }

  if(mode==="block"){ if(d.val==="O"||d.val==="X"||d.ruined) return; d.val="#"; skill[current].block--; skill[current].mode=null; usedSkillThisTurn=true; render(); updateSkillButtons(); return; }
  if(mode==="override"){ if(d.protect || d.val===current){ const el=cellEl(r,c); el.classList.add("shake"); setTimeout(()=>el.classList.remove("shake"),350); return; } if(d.val===""||d.val==="#"||d.ruined) return; d.val=current; d.protect=false; skill[current].override--; skill[current].mode=null; usedSkillThisTurn=true; render(); updateSkillButtons(); if(checkWin(r,c)) return; nextTurn(); return; }
  if(mode==="protect"){ if(d.val!==""||d.val==="#") return; d.val=current; d.protect=true; skill[current].protect--; skill[current].mode=null; usedSkillThisTurn=true; render(); updateSkillButtons(); if(checkWin(r,c)) return; nextTurn(); return; }

  if(d.val!==""||d.val==="#"||d.ruined) return;
  d.val=current; d.protect=false;
  render(); if(checkWin(r,c)) return; nextTurn();
}

// --- ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ ---
let touchStartX=0, touchStartY=0;
const swipeThreshold=30;
const boardContainer=document.getElementById("board");
boardContainer.addEventListener("touchmove", e=>{ e.preventDefault(); }, { passive:false });
boardContainer.addEventListener("touchstart", e=>{ touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY; });
boardContainer.addEventListener("touchend", e=>{
  const dx=e.changedTouches[0].clientX - touchStartX;
  const dy=e.changedTouches[0].clientY - touchStartY;
  if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>swipeThreshold){ dx>0?shiftBoard("right"):shiftBoard("left"); }
  else if(Math.abs(dy)>swipeThreshold){ dy>0?shiftBoard("down"):shiftBoard("up"); }
});
function shiftBoard(dir){
  if(gameOver || phase==="mine") return;
  if(dir==="left"){ for(let r=0;r<N;r++){ board[r].push(board[r].shift()); } }
  else if(dir==="right"){ for(let r=0;r<N;r++){ board[r].unshift(board[r].pop()); } }
  else if(dir==="up"){ board.push(board.shift()); }
  else if(dir==="down"){ board.unshift(board.pop()); }
  render();
}

// --- å¼·ã„AI + ã‚¹ã‚­ãƒ«/åœ°é›·ä½¿ç”¨ ---
function nextTurn(){
  current=current==="O"?"X":"O";
  usedSkillThisTurn=false;
  updateTurn();
  if(isBoardFull()) openRandomCells(10);
  if(!gameOver && current==="X") setTimeout(computerMove, 400);
}

function computerMove(){
  if(gameOver) return;

  // --- 1. å‹åˆ©ç‹™ã„ ---
  for(let r=0;r<N;r++){ for(let c=0;c<N;c++){ if(board[r][c].val===""){ board[r][c].val="X"; if(checkWin(r,c)) return; board[r][c].val=""; } } }

  // --- 2. ç›¸æ‰‹é˜»æ­¢ ---
  for(let r=0;r<N;r++){ for(let c=0;c<N;c++){ if(board[r][c].val===""){ board[r][c].val="O"; if(checkWin(r,c)){ board[r][c].val="X"; render(); nextTurn(); return; } board[r][c].val=""; } } }

  // --- 3. ã‚¹ã‚­ãƒ«ä½¿ç”¨ ---
  // override: è‡ªåˆ†ã®é€£ç¶šã‚’ä½œã‚‹
  if(skill.X.override>0){
    for(let r=0;r<N;r++){ for(let c=0;c<N;c++){
      if(board[r][c].val==="O" && !board[r][c].protect){ board[r][c].val="X"; skill.X.override--; render(); if(!checkWin(r,c)) nextTurn(); return; }
    }}
  }
  // protect: æœ‰åˆ©ãªã‚»ãƒ«ã‚’å®ˆã‚‹
  if(skill.X.protect>0){
    for(let r=0;r<N;r++){ for(let c=0;c<N;c++){
      if(board[r][c].val==="X" && !board[r][c].protect){ board[r][c].protect=true; skill.X.protect--; render(); if(!checkWin(r,c)) nextTurn(); return; }
    }}
  }
  // block: ç›¸æ‰‹ãŒæœ‰åˆ©ãªç©ºã‚»ãƒ«ã‚’å¡ã
  if(skill.X.block>0){
    for(let r=0;r<N;r++){ for(let c=0;c<N;c++){
      if(board[r][c].val===""){ board[r][c].val="#"; skill.X.block--; render(); nextTurn(); return; }
    }}
  }

  // --- 4. ä¸­å¤®ãƒ»è§’å„ªå…ˆ ---
  const priority=[[3,3],[0,0],[0,6],[6,0],[6,6]];
  for(const [r,c] of priority){ if(board[r][c].val===""){ board[r][c].val="X"; render(); if(!checkWin(r,c)) nextTurn(); return; } }

  // --- 5. ç©ºã‚»ãƒ«ãƒ©ãƒ³ãƒ€ãƒ  ---
  const empty=[];
  for(let r=0;r<N;r++){ for(let c=0;c<N;c++){ if(board[r][c].val==="") empty.push([r,c]); } }
  if(empty.length>0){ const [r,c]=empty[Math.floor(Math.random()*empty.length)]; board[r][c].val="X"; render(); if(!checkWin(r,c)) nextTurn(); }
}

// --- åˆæœŸåŒ–å‘¼ã³å‡ºã— ---
init();

// --- PWA Service Worker ---
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("./service-worker.js");
  });
}
</script>

</body>
</html>
